---
title: "Russians in Japan"
subtitle: ""
author: ""
date: '`r Sys.Date()`'
# bibliography: references.bib
link-citations: true
# abstract: \singlespacing Abstract which has to be long enough to 
#   take multiple lines otherwise one does not see the effect of single-spacing.
output: 
   html_document:
      number_sections: TRUE
      fig_caption: TRUE
      toc: TRUE
      toc_depth: 5
      toc_float: TRUE
      theme:
         bootswatch: minty
         # bootswatch: cosmo
      highlight: espresso
      # espresso, tango, zenburn
      code_folding: show
      # code_download: TRUE
      fig_width: 10
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
# knitr::opts_knit$set(root.dir = ".")  # modify with the location of code
```

# Preparations {.tabset .tabset-fade .tabset-pills}

## R Packages
```{r, echo=FALSE, message=FALSE}
# Data manipulation
library(tidyverse)
library(data.table)
library(janitor)  # janitor::row_to_names()
library(DT)
library(stringr)
library(lubridate)

# Visualisation
library(ggplot2)
library(patchwork)
library(broman)  # plot_crayons()
library(rcartocolor)  # display_carto_all(); https://bit.ly/3Itq5kB
library(extrafont)  # "Candara"
library(RColorBrewer)

# Interactivity
library(plotly)
library(crosstalk)

# GeoSpatial Analysis
library(sf)  # simple feature
library(spdep)  # helpful functions for mapping
library(rmapshaper)  # helpful functions for mapping
library(tmap)  # map viewer
library(leaflet)  # map viewer
library(mapview)  # map viewer
library(rnaturalearth)

# Parallel
library(purrr)
library(foreach)
library(doParallel)

# Descriptive Statistics
library(naniar)
library(psych)
library(gtsummary)

# Multi Level Model
library(lme4)
library(lmerTest)
library(coefplot)

# Stan
library(rstan)
library(bayesplot)
library(broom)
library(broom.mixed)
```

## Environment
```{r Environment}
# rgb(73, 81, 112, maxColorValue = 255): "#495170"
col.os <- "#414a4c"  # Outer Space
col.rp <- "#7851a9"  # Royal Purple
col.cb <- "#b0b7c6"  # Cadet Blue
col.el <- "#ceff1d"  # Electric Lime
col.rm <- "#e3256b"  # Razzmatazz
col.rd <- "#ee204d"  # Red
col.plos.ye <- "#D6E13D"  # PLOS ONE Yellow
col.plos.pink <- "#CF00A3"  # PLOS ONE Pink
scale.col.1 <- c()
font.base <- "Candara"
theme_set(theme_minimal(base_family = font.base))
options(dplyr.summarise.inform = TRUE)
# Twitter Logo and Acc
t.img <- png::readPNG("fig/twitter.png")
t.grob <- grid::rasterGrob(t.img, 
                           width = unit(0.4, "cm"), 
                           height = unit(0.4, "cm"),
                           interpolate = FALSE)
```

# Load DataSets {.tabset .tabset-fade .tabset-pills}
```{r Load DataSets}
russians <- read_csv("input/Russian.csv")

ne.jpn.sf <- ne_states(country = "Japan", returnclass = "sf") %>% 
   rmapshaper::ms_filter_islands(min_area = 1e8)  # remove small islands
```

# Preprocessing
```{r}
ne.jpn.sf <- ne.jpn.sf %>% 
   select(iso_3166_2, name, region, latitude, longitude) %>%
   tibble::new_tibble(nrow = nrow(.), class = "sf") %>% 
   left_join(russians %>% select(Prefecture_name, Pop), 
             by = c("name" = "Prefecture_name"))
glimpse(ne.jpn.sf)
```

# Draw map
```{r, fig.height=13}
p1 <- ggplot(data = ne.jpn.sf) + 
   geom_sf(mapping = aes(fill = Pop), 
           size = 0.05, color = col.os) + 
   geom_text(aes(x = longitude, y = latitude, label = Pop), 
             data = ne.jpn.sf %>% filter(Pop > 100), 
             color = col.os, cex = 1.5, family = font.base) + 
   # geom_sf_text(mapping = aes(label = Pop), 
   #              data = ne.jpn.sf %>% filter(Pop > 100), 
   #              color = col.os, cex = 1.5, family = font.base) + 
   scale_fill_gradient(
      name = "Population", 
      low = "white", high = col.rd, 
      breaks = c(100, 200, 400, 800, 1600)
      # as.numeric(quantile(ne.jpn.sf$Pop, probs = seq(0, 1, 0.1)))
   ) + 
   guides(fill = guide_colourbar(
      barwidth = 1, barheight = 10, label.position = "left", 
      ticks.linewidth = 2
    )) + 
   labs(x = NULL, y = NULL, title = "Russian Population by Prefecture") + 
   theme(legend.position = c(0.8, 0.25), 
         legend.title = element_text(size = 10))

p1
ggsave(filename = "fig/russians.jpg", 
       plot = p1, width = 6, height = 8, dpi = 200)
```

