---
title: "Spatial Clustering: ClustGeo"
subtitle: ""
author: "Maxwell"
date: '`r Sys.Date()`'
# bibliography: references.bib
link-citations: true
output: 
   html_document:
      number_sections: TRUE
      fig_caption: TRUE
      toc: TRUE
      toc_depth: 5
      toc_float: TRUE
      theme:
         bootswatch: minty
         # bootswatch: cosmo
      highlight: espresso
      # espresso, tango, zenburn
      code_folding: hide
      # code_download: TRUE
      fig_width: 10
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

https://cran.r-project.org/web/packages/ClustGeo/vignettes/intro_ClustGeo.html

# Preparations {.tabset .tabset-fade .tabset-pills}

## Load libraries
```{r, echo=FALSE, message=FALSE}
# Data manipulation
library(tidyverse)
library(data.table)
library(janitor)  # janitor::row_to_names()
library(DT)
library(stringr)
library(lubridate)

# Visualisation
library(ggplot2)
library(plotly)
library(patchwork)
library(broman)  # plot_crayons()
library(rcartocolor)  # display_carto_all(); https://bit.ly/3Itq5kB
library(RColorBrewer)  # display.brewer.all()
library(extrafont)  # "Candara"
library(grid)

# Geospatial Analysis
library(sf)  # simple feature
library(spdep)  # helpful functions for mapping: skater
library(ClustGeo)  # Spatial Clustering
library(rmapshaper)  # helpful functions for mapping
library(leaflet)  # map viewer
library(mapview)  # map viewer

# Descriptive Statistics
library(naniar)
library(psych)
library(gtsummary)

source("utility/helper_functions.R")
```

## Environment
```{r Environment}
col.os <- "#414a4c"  # Outer Space
col.rp <- "#7851a9"  # Royal Purple
col.cb <- "#b0b7c6"  # Cadet Blue
col.el <- "#ceff1d"  # Electric Lime
col.rm <- "#e3256b"  # Razzmatazz
col.plos.yellow <- "#D6E13D"  # PLOS ONE
scale.col.1 <- c()
font.1 <- "Candara"
theme_set(theme_minimal(base_family = font.1))
options(dplyr.summarise.inform = TRUE)

t.img <- png::readPNG("fig/twitter.png")
t.grob <- grid::rasterGrob(t.img, 
                           width = unit(0.4, "cm"), 
                           height = unit(0.4, "cm"),
                           interpolate = FALSE)
```

# Load DataSets {.tabset .tabset-fade .tabset-pills}
The dataset `estuary` refers to **303 French municipalities of Gironde estuary (a south-ouest French region)**.  

- dat: `data.frame` with the description of the 303 municipalities on 4 socio-economic variables.  
- D.geo: `matrix` with the distances (303, 303) between the town halls of the 303 municipalities.  
- map: `sp::SpatialPolygonsDataFrame` with the map of the municipalities.  

```{r Load DataSets}
data(estuary, package = "ClustGeo")
print(class(estuary))
print(names(estuary))
```

## dat
```{r}
dat <- estuary$dat
print(dim(dat))
view.table(dat, head.n = 100)
```

## D.geo
```{r}
D.geo <- estuary$D.geo
print(dim(D.geo))
```

## map
```{r}
map <- estuary$map
cat("dim(map):", dim(map), "\n")
cat("dim(map@data):", dim(map@data), "\n")
cat("map@plotOrder[1:10]:", map@plotOrder[1:10], "\n")
cat("map@bbox:")
print(map@bbox)
```
```{r, fig.width=5, fig.height=10}
ggplot(data = map %>% st_as_sf()) + 
  geom_sf(fill = col.plos.yellow, color = col.os, alpha = 1) + 
  labs(x = NULL, y = NULL, 
       title = "303 French municipalities of Gironde estuary") + 
  annotation_custom(grob = t.grob, 
                    xmin = 420000, xmax = 420000, 
                    ymin = 6310000, ymax = 6310000) + 
  annotate(geom = "text", x = 433000, y = 6310000, 
           label = "@Maxwell_110", size = 3, family = "Candara")

ggsave("fig/ClustGeo_01_French-municipalities.jpg", width = 5, height = 10)
```

```{r}
identical(as.vector(map$INSEE_COM), rownames(dat))
```


# `hclustgeo`: Hierarchical clustering with soft contiguity constraint

> hclustgeo(D0, D1 = NULL, alpha = 0, scale = TRUE, wt = NULL)

**D0**: class `dist` with the dissimilarities between the n observations. The function as.dist can be used to transform an object of class matrix to object of class dist.

**D1**: class `dist` with other dissimilarities between the same n observations.

**alpha**: value between 0 and 1. This mixing parameter gives the relative importance of D0 compared to D1. By default, this parameter is equal to 0 and D0 is used alone in the clustering process.

**scale**: if TRUE the two dissimilarity matric D0 and D1 are scaled i.e. divided by their max. If D1=NULL, this parameter is not used and D0 is not scaled.

**wt**: vector with the weights of the observations. By default, wt=NULL corresponds to the case where all observations are weighted by 1/n.

```{r}
D0 <- dist(dat)
tree.1 <- 
  ClustGeo::hclustgeo(D0 = D0, D1 = NULL, alpha = 0, scale = TRUE, wt = NULL)
```

```{r}
plot(tree.1, hang = -1, label = FALSE, 
     xlab = "", sub = "", 
     main = "Ward dendrogram with D0 only")

rect.hclust(tree.1 , k = 5, border = c(4, 5, 3, 2, 1))
legend("topright", legend = paste("cluster", 1:5), 
       fill = 1:5, bty = "n", border = "white")
```

